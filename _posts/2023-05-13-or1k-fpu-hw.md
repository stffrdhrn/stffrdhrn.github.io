---
title: OpenRISC FPU Port - Fixing Hardware
layout: post
date: 2023-05-13 09:50
categories: [ hardware, embedded, openrisc ]
---

In the [last article](http://a.c) we introduced the OpenRISC glibc FPU port and the effort
required to get user space FPU support into OpenRISC linux user applications.
We explained how the FPU port is a fullstack project covering:

 - Architecture Specification
 - Simulators and CPU implementations
 - Linux Kernel support
 - GCC Instructions and Soft FPU
 - Binutils/GDB Debugging Support
 - glibc support

In this entry we will cover updating *Simulators and CPU implementations* to support
the architecture changes which are called for as per the previous article.

 - Allowing usermode programs to update the FPCSR register
 - Defining tininess before routing

# Simulator Updates

The main simulator we use is QEMU.  The update was done in my
[OpenRISC user space FPCSR](https://lore.kernel.org/qemu-devel/20230511151000.381911-1-shorne@gmail.com/#r)
qemu patch series.  The series was merged for the
[qemu 8.1](https://wiki.qemu.org/ChangeLog/8.1) release.

...

# RTL Updates

The RTL updates look as follows

User mode support.

```
commit 6b1beaa871c02ccd570d8e6ad80f99bc4133aa26 (origin/fpcsr_free_access)
Author: Andrey Bacherov <bandvig@mail.ru>
Date:   Sat Jan 15 11:34:23 2022 +0300

    Make FPCSR is R/W accessible for both user- and supervisor- modes.

diff --git a/rtl/verilog/mor1kx_ctrl_cappuccino.v b/rtl/verilog/mor1kx_ctrl_cappuccino.v
index f9aec21..40d11cf 100644
--- a/rtl/verilog/mor1kx_ctrl_cappuccino.v
+++ b/rtl/verilog/mor1kx_ctrl_cappuccino.v
@@ -618,7 +618,7 @@ module mor1kx_ctrl_cappuccino
            spr_fpcsr[`OR1K_FPCSR_FPEE] <= 1'b0;
          end  
          else if ((spr_we & spr_access[`OR1K_SPR_SYS_BASE] &
-                  (spr_sr[`OR1K_SPR_SR_SM] & padv_ctrl | du_access)) &&
+                  (padv_ctrl | du_access)) &&
                   `SPR_OFFSET(spr_addr)==`SPR_OFFSET(`OR1K_SPR_FPCSR_ADDR)) begin
            spr_fpcsr <= spr_write_dat[`OR1K_FPCSR_WIDTH-1:0]; // update all fields
           `ifdef OR1K_FPCSR_MASK_FLAGS
```

The change to verilog shows that before when writng (`spr_we`) to the FPCSR (`OR1K_SPR_FPCSR_ADDR`) register
we used to check that the supervisor bit (`OR1K_SPR_SR_SM`) bit of the sr spr (`spr_sr`) is set.  That check
enforced supervisor mode only write access, removing this allows user space to write to the regsiter.

This implementation already allowed read access.

Updating for tininess was done in 2 of our main OpenRISC cores in the following
patches.

 - mor1kx          - [f2a78cc5d98](https://github.com/openrisc/mor1kx/commit/f2a78cc5d98123e63af4b23296795d95ffdfd854)
 - or1k_marocchino - [8be054f0bef](https://github.com/openrisc/or1k_marocchino/commit/8be054f0bef95bd94238509ced79ef5ec7a57417)

I will not go into details of these patches as I didnt write them.  But I
general they are medium size refactorings of the floating point unit.
